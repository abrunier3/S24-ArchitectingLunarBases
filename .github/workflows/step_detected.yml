name: STEP File Detected â€” Create Model Folder & Registration Issue

on:
  push:
    paths:
      - 'models/*.step'
      - 'models/*.stp'
      - 'models/*.STEP'
      - 'models/*.STP'

jobs:
  register-model:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect new STEP files
        id: detect
        run: |
          STEP_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep -iE '\.(step|stp)$' | grep '^models/' || true)
          if [ -z "$STEP_FILES" ]; then
            echo "No new STEP files detected."
            echo "has_files=false" >> $GITHUB_OUTPUT
          else
            echo "New STEP files: $STEP_FILES"
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "step_files<<EOF" >> $GITHUB_OUTPUT
            echo "$STEP_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create folders and issues for each STEP file
        if: steps.detect.outputs.has_files == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORM_BASE_URL: "https://abrunier3.github.io/S24-ArchitectingLunarBases/sysml_generator.html"
          REPO: ${{ github.repository }}
          PUSHER: ${{ github.actor }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          echo "${{ steps.detect.outputs.step_files }}" | while IFS= read -r STEP_PATH; do
            [ -z "$STEP_PATH" ] && continue

            STEP_FILE=$(basename "$STEP_PATH")
            STEM="${STEP_FILE%.*}"
            FOLDER="models/${STEM}"
            SHORT_SHA="${COMMIT_SHA:0:7}"

            echo "Processing: $STEP_FILE"

            mkdir -p "$FOLDER"

            # Move the .step file into its subfolder
            git mv "$STEP_PATH" "$FOLDER/$STEP_FILE"
            echo "Moved $STEP_PATH to $FOLDER/$STEP_FILE"

            ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${STEP_FILE}'))")
            FORM_URL="${FORM_BASE_URL}?step=${ENCODED}"

            printf "## New CAD Model Detected\n\n**File:** \`%s\`\n**Pushed by:** @%s\n**Commit:** \`%s\`\n**Model folder:** \`%s/\`\n\n---\n\n### Next step: Fill in the model attributes\n\nA folder has been created at \`%s/\`. You now need to generate the SysML metadata file.\n\n**Open the Model Registration Form:** %s\n\nThe form is pre-filled with the STEP file name. Fill in dimensions, orientation, material, units, and any custom attributes.\n\nOnce done, download the generated \`.sysml\` file and commit it to:\n\`%s/%s.sysml\`\n\n---\n*This issue was created automatically by the S24 DEE pipeline.*\n" \
              "$STEP_PATH" "$PUSHER" "$SHORT_SHA" "$FOLDER" "$FOLDER" "$FORM_URL" "$FOLDER" "$STEM" > /tmp/BODY.md

            gh issue create \
              --repo "$REPO" \
              --title "New STEP file detected: ${STEP_FILE}" \
              --body-file /tmp/BODY.md \
              --label "model-registration" || \
            gh issue create \
              --repo "$REPO" \
              --title "New STEP file detected: ${STEP_FILE}" \
              --body-file /tmp/BODY.md

            echo "Done for $STEP_FILE"
          done

      - name: Commit new folders
        if: steps.detect.outputs.has_files == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add models/
          git diff --staged --quiet || git commit -m "chore: move STEP file(s) into model subfolder(s) [skip ci]"
          git push
